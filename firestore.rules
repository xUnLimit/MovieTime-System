rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    // ============================================================================
    // ALL APPLICATION COLLECTIONS
    // Any authenticated user can read and write.
    // Role-based access control is handled client-side.
    // ============================================================================

    match /usuarios/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /ventas/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /servicios/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /pagosServicio/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /pagosVenta/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /categorias/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /metodosPago/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /activityLog/{docId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if false; // Immutable audit trail
    }

    match /config/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /templates/{docId} {
      allow read, write: if isAuthenticated();
    }

    match /gastos/{docId} {
      allow read, write: if isAuthenticated();
    }

    // ============================================================================
    // LEGACY COLLECTIONS (read-only)
    // ============================================================================

    match /clientes/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /revendedores/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /suscripciones/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
